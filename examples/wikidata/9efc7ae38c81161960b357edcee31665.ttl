@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix schema: <https://schema.org/> .

<https://www.wikidata.org/#query-9efc7ae38c81161960b357edcee31665> a sh:SPARQLExecutable,
    sh:SPARQLSelectExecutable;
  dcterms:isPartOf <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/lb>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/th>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/eu>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/en-gb>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/vec>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/hy>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/id>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/be-tarask>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/tr>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ro>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/he>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/zh>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/pt-br>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/si>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/eo>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/da>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ar>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ko>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/pl>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ms>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/sv>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/lt>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/nl>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ca>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/uk>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/it>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ja>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/es>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/cs>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ru>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/de>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/fr>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/en>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples>;
  dcterms:license <https://creativecommons.org/licenses/by-sa/4.0/>;
  sh:prefixes _:genid-4e694113159d4e3db4a1a913894a81d856087-wikidata_prefixes, _:genid-4e694113159d4e3db4a1a913894a81d856087-66EBD57BF82CA364FC2848EB1B576F1A,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-6AA417136F50079EDC934C859CE18316, _:genid-4e694113159d4e3db4a1a913894a81d856087-259F1321C325499ABB7B089ACE6E7E4F,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-5F9C9746D745F810A739A137015C362C, _:genid-4e694113159d4e3db4a1a913894a81d856087-C69BE51C619284CF7BF8F38C42AD9B76,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-78092CF8DBAB45562144088A939B9FE8, _:genid-4e694113159d4e3db4a1a913894a81d856087-76368C9A655E36636B16AA98531DC744,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-291EE5B9B38376BC7B1E5532EE01D463, _:genid-4e694113159d4e3db4a1a913894a81d856087-EAB8602BCC453F498D90E8121FEBCF83,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-F7753290F5B0DB8C3784014F1A3E3DD8, _:genid-4e694113159d4e3db4a1a913894a81d856087-DEB4083DFDE40147F90E637CB91EE850,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-313663BE6CC42138EA2ED6E99237E989, _:genid-4e694113159d4e3db4a1a913894a81d856087-AFBECC3EF01C3581590B906E03040DA9,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-D384AE612C843821E5D47371DE79BBD8, _:genid-4e694113159d4e3db4a1a913894a81d856087-05E7D266DBB0FDAE8AF19750BB578EBA,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-BE486E5062274C59F651D9DDC9D18F2B, _:genid-4e694113159d4e3db4a1a913894a81d856087-95721A2051E3E693840578271862459D,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-8B182D0FB6F4B6CF9DC299AFD1179E33, _:genid-4e694113159d4e3db4a1a913894a81d856087-9C941DD40677781850070C95B2931650,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-18AB4A97E1B1F5B9D6CE6D1AD0288DC9, _:genid-4e694113159d4e3db4a1a913894a81d856087-7714F80248DFFD24EEEA9B242D748B34,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-32F4EF1E8257DDDDD9790EA08FDC0B0D, _:genid-4e694113159d4e3db4a1a913894a81d856087-F0BA192885D3568A28BE3DF88D30F646,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-28C7999565F2333A369121187C951EC3, _:genid-4e694113159d4e3db4a1a913894a81d856087-F30223ECC003BE6356404DDC2FAFEC49,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-B7647AABE97E4541E377C5B3AF993346, _:genid-4e694113159d4e3db4a1a913894a81d856087-1CD8953770EE9EF5E3CD8A8ACE2FEEB9,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-B1384A68B9AC85162DE2FB1A48CB5C09, _:genid-4e694113159d4e3db4a1a913894a81d856087-7D26A5843EA24E88B7D4C3AAF912A1E3,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-CBF9C36F816DE9794A14FF583CEC7850, _:genid-4e694113159d4e3db4a1a913894a81d856087-8FA101D4DAD75903770B1DE01A5D8C54,
    _:genid-4e694113159d4e3db4a1a913894a81d856087-09D5EC359369ED43AEF2443CDEF53C38, _:genid-4e694113159d4e3db4a1a913894a81d856087-240C2F7D23495B2FF49B55DC919D675C;
  schema:target <https://query.wikidata.org/sparql/>;
  sh:select """PREFIX wikibase: <http://wikiba.se/ontology#>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX bd: <http://www.bigdata.com/rdf#>
# Each composer’s most used tonality, with number of works in that tonality.
# (If this is ambiguous – multiple tonalities with the same number – there are multiple results for one composer.)
#
# The SPARQL for this is an evil perversion of three subqueries (one of them nested in another).
# To understand it, you have to go inside out… follow the numbers.

SELECT ?composerLabel ?tonalityLabel ?count
WHERE
{
  {
    # 4. Group again, this time just by the composer.
    #    We also select the highest count of a tonality.
    #    Notice that we don’t know what tonality this count is associated with – we’ll get to that.
    #    So now we have each composer, along with how often they used whatever tonality they used most.
    SELECT ?composer (MAX(?count) AS ?count_)
    WHERE
    {
      {
        # 2. Group by composer and tonality, so that for each composer and tonality, we get a count of how often the composer used this tonality.
        SELECT ?composer ?tonality (COUNT(?composition) AS ?count)
        WHERE
        {
          # 1. Extremely straightforward: the ?composition has the composer ?composer and the tonality ?tonality.
          #    (I’m not bothering with any “instance of” because the presence of these two properties is a sufficient indicator of ?composition being a composition.)
          ?composition wdt:P86 ?composer;
                       wdt:P826 ?tonality.
        }
        GROUP BY ?composer ?tonality
        HAVING(?count > 1) # 3. Limit that to counts > 1, because using a tonality once is hardly “most used”.
      }
    }
    GROUP BY ?composer
  }
  {
    # 6. Identical to 2.
    SELECT ?composer ?tonality (COUNT(?composition) AS ?count)
    WHERE
    {
      # 5. Identical to 1.
      ?composition wdt:P86 ?composer;
                   wdt:P826 ?tonality.
    }
    GROUP BY ?composer ?tonality
    HAVING(?count > 1) # 7. Identical to 3.
  }
  # 8. That’s it. Wait, what?
  #    From 4, we now have ?composer, any composer, and ?count, the count of how often they used whatever tonality they used most.
  #    From 6, we also have a ?composer, as well as a ?tonality, and the count of how often they used that particular tonality.
  #    The trick is that ?composer and ?count are the same variable in each subquery, and so now, when the two subqueries are joined,
  #    we select only that ?tonality from 6 where the ?composer and the ?count are identical to those from 4 –
  #    that is, where this tonality was used as often as the composer’s most-used tonality.
  #    In other words, this must *be* the composer’s most-used tonality (except when there are multiple tonalities with the same count).
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }
}
ORDER BY DESC(?count) # 9. Order by count (highest first), because the result isn’t very meaningful for low counts (many compositions aren’t on Wikidata or don’t have a tonality statement).""" .
