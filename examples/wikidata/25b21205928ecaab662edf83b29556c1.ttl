@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix schema: <https://schema.org/> .

<https://www.wikidata.org/#query-25b21205928ecaab662edf83b29556c1> a sh:SPARQLExecutable,
    sh:SPARQLSelectExecutable;
  rdfs:comment """ This page is an archive. Please do not modify it. Use the current page, even to continue an old discussion. Contents 1 Find a vietnamese article 2 Weird time-out in a query 3 #TEMPLATE 4 Persons having an ID on Canadian Encyclopedia artikkel-ID 5 Member of Organized Crime gangs 6 Query to Obtain City of the Airport [SOLVED] 7 Is it possible to list people with items created in the last 12 months? 8 gsbbox equivalent 9 Ruth (Surname) 10 Modify a query to cast the same globe 11 Pictures both used on wikidata and locally in infoboxes 12 all DOI? 13 Colouring graph nodes and labelling relationships 14 Performance issue when a MINUS is added to my query 15 SPARQL 16 Getting city & latitude / longitude from residence & university values 17 Why is this querry so slow, can it be made faster? 18 All Persons, their DOB, DOD (if applicable) and Occupation 19 Find all countries and their administrative regions at all levels, including states, cities, counties, etc. 20 Agregar una tabla de wiki data a una nota en wikipedia 21 need wiki data query to extract yearly propulation growth of countries 22 Enlazar wikidata con wikipedia 23 Leaders and other metadata for each battle/sieges during the Sengoku Period. 24 Greek Given names 25 Missing citizenship 26 Missing articles in English 27 Checking where entities are referred 28 Filter fr description 29 Page ranges 30 Query for pages without Scholia link 31 References used in an item 32 Facts from specific domain 33 United States Senators/House reps who have been astronauts 34 A list of false cognates (lexemes) between Portuguese and Esperanto 35 Get all latin alphabet interwikis of an item 36 Result empty after 440th row though result is >2000, where is the error? 37 Policia EEUU 38 SPARQL on Commons 39 query information from the wiki archive 40 which properties are used in a subclass 41 Slow query on label 42 All rivers in europe with mouth and spring 43 show source 44 This query times out 45 Articles in idwiki but does not exist in enwiki 46 Wars 47 why can't find any city in USA using label ? 48 Australian Women's Register ID 49 FILTER NOT EXISTS for wdt:Pxxxx OR wdt: Pnnnnn? 50 query of villages in a certain district in China also having having Tibetan name set 51 Wrong query 52 Joseph de Cambis 53 Get items with deleted Commons images through a query 54 Find the longest river, sort by desc. Take 22 seconds, can it be improved further ? 55 global universities 56 How to optimize nested OPTIONAL ? 57 Can inverse property paths be used in the GAS service? 58 Query to identify the actors who were in films shot in Georgia. 59 query to get politician data 60 Multiple dates of death 61 Query for case variants of strings 62 How to limit result to qualifier with oldest value - searching former municipalities in Finland 63 Data quality : inception (P571) and dissolved, abolished or demolished date (P576) 64 elementos con propiedad que tenga varios calificativos 65 Works with Creators' Gender 66 List of authors in the Portuguese Wikisource sorted by name and last name 67 Items in a defined territory, showing missing labels and descriptions 68 Incorrect results looking for senate seats? 69 Items with coordinates within an OSM relation 70 Refining a Listeria query 71 Not DISTINCT? 72 List of religions by country 73 Sorting and grouping in query 74 Sort dates according to BC / AD 75 Re-running queries on earlier versions of Wikidata 76 Trouble with ORDER BY 77 Folding values in a query 78 Make a tree father country > child country (or the reverse) more visuable 79 Chess champions 80 Iconclass/project:sum of all paintings 81 Dates 82 No results for congresses 1-3? 83 In the commons category 84 Taxonomic class for Critter of the Week 85 Query to get UG Space Bibliographic Wikidata Items 86 publications from a particular year and place 87 Retrieving Wikidata data for list of items (QIDs) in SPARQL-XML format Find a vietnamese article Find a vietnamese article about a plant taxon which begins with \"P\" which and which contains an image file beginning with \"P\" but where there is no matching English wikipedia article. MargaretRDonald (talk) 00:36, 31 October 2020 (UTC) @MargaretRDonald: WDQS has no insight into images held within a vi-wiki article. This query satisfies your other specification points, and in addition checks whether the wikidata item has an image starting with P. Does that help? SELECT ?item ?itemLabel ?image ?article WITH {SELECT ?item ?image ?article
WHERE 
{
  ?article schema:about ?item ;
          schema:isPartOf <https://vi.wikipedia.org/> .
  ?item wdt:P31 wd:Q16521 .
  ?item wdt:P18 ?image . 
} } as %i
WHERE
{
  INCLUDE %i
  FILTER NOT EXISTS { 
    ?article2 schema:about ?item ;
          schema:isPartOf <https://en.wikipedia.org/> .
                    }
  filter (contains(str(?image),\"FilePath/P\"))
  filter (contains(str(?article),\"wiki/P\"))  
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
  }
 Try it! --Tagishsimon (talk) 01:34, 31 October 2020 (UTC) WDQS can in fact query about which images are used in viwiki articles via the MediaWiki API. But I have trouble seeing how the first character of the image names can be relevant as image names can be any text in any language. --Dipsacus fullonum (talk) 07:51, 31 October 2020 (UTC) Besides, the images returned from MWAPI are any file used on a page. There is no way to know if it is actually an image of the taxon, or e.g. an icon used in a hatnote or stub template or anything like that. --Dipsacus fullonum (talk) 08:04, 31 October 2020 (UTC) Thank you both for your thoughts (very helpful indeed). @Tagishsimon: @Dipsacus fullonum: I have modified te query slightly to get only taxa with APNI ids, and ideally would like to limit the results to files in the commons category [[Category:Photographs by Kevin Thiele]] SELECT ?item ?itemLabel ?image ?article WITH {SELECT ?item ?image ?article
WHERE 
{
  ?article schema:about ?item ;
          schema:isPartOf <https://vi.wikipedia.org/> .
  ?item wdt:P31 wd:Q16521 .
  ?item wdt:P18 ?image .
  ?item wdt:P5984 ?apni .
} } as %i
WHERE
{
  INCLUDE %i
  FILTER NOT EXISTS { 
    ?article2 schema:about ?item ;
          schema:isPartOf <https://en.wikipedia.org/> .
                    }
  filter (contains(str(?image),\"FilePath/P\"))
  filter (contains(str(?article),\"wiki/P\"))  
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
  }
 Try it! MargaretRDonald (talk) 07:02, 1 November 2020 (UTC)@MargaretRDonald: It is no problem limiting to files in the category. Just add a subquery to find the category members and match the image names from the two subqueries. I also moved two filters to the first subquery for efficiency and reformated the query to my preferences as I cannot read a query well if matching brackets are not in the same columns. So: SELECT ?item ?itemLabel ?image ?article ?image_title
WITH
{
  SELECT ?item ?image ?article ?image_title
  WHERE 
  {
    ?article schema:about ?item ;
             schema:isPartOf <https://vi.wikipedia.org/> .
    ?item wdt:P31 wd:Q16521 .
    ?item wdt:P18 ?image .
    ?item wdt:P5984 ?apni .
    FILTER (CONTAINS(STR(?image),\"FilePath/P\"))
    FILTER (CONTAINS(STR(?article),\"wiki/P\"))  
    BIND (SUBSTR(wikibase:decodeUri(STR(?image)), 52) AS ?image_title)
  }
} AS %i
WITH
{
  SELECT ?image_title
  WHERE
  {
    SERVICE wikibase:mwapi
    {
      bd:serviceParam wikibase:endpoint \"commons.wikimedia.org\" .
      bd:serviceParam wikibase:api \"Generator\" .
      bd:serviceParam mwapi:generator \"categorymembers\" .
      bd:serviceParam mwapi:gcmtitle \"Category:Photographs by Kevin Thiele\" .
      bd:serviceParam mwapi:gcmtype \"file\" .
      bd:serviceParam mwapi:gcmprop \"title\" .
      bd:serviceParam mwapi:gcmlimit \"max\" .
      ?file wikibase:apiOutput mwapi:title .
    }
    BIND (SUBSTR(?file, 6) AS ?image_title)
  }
} AS %wanted_image_titles
WHERE
{
  INCLUDE %i
  INCLUDE %wanted_image_titles
  FILTER NOT EXISTS
  { 
    ?article2 schema:about ?item ;
              schema:isPartOf <https://en.wikipedia.org/> .
  }
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
}
 Try it! --Dipsacus fullonum (talk) 08:13, 1 November 2020 (UTC) @Dipsacus fullonum: Perfect. Thanks heaps. MargaretRDonald (talk) 09:20, 1 November 2020 (UTC) Weird time-out in a query Here's a query that is giving me weird time-outs, and I don't understand why, given that with very small changes I can make it not time out (but also not give me the results I want). The query is work-in-progress, towards plotting how Scottish church ministers moved from one job to another. The key thing I'm trying to get here are the coordinates on each line for their previous job, and the coordinates for their current job; so that I then would be able to plot a line between them.The code below times out.But weirdly, if I comment out the lines giving me ?form_lat and ?from_lon then everything works (tinyurl.com/yxbhcm37) though of course I don't get the 'from' coords. Interestingly, it is not the line ?from p:P625 ?from_coords_stmt which seems to cause a problem, but rather any subsequent use of ?from_coords_stmt, eg even ?from_coords_stmt ps:P625 ?from_coords (tinyurl.com/yxgjyoue ; cf also tinyurl.com/y2kz9uts). I don't understand this.Also, if I remove the OPTIONAL from the join in the %ministers_moves block, then the problem goes away. tinyurl.com/yy54r62r (But then I don't get a line in the output for the minister's first job). For the ministers' first jobs, with the OPTIONAL, the COALESCE should give ?from the same value as ?place. And the query can find the coordinates for ?place with no problem. So why is it failing for ?from ?This kind of time-out is the sort of thing that could happen from a typo, if the typo led to a line with a triple with unbound variables. But I don't think I've made a typo, or got unbound variables that I can see. Can anybody spot or explain what might be going on here? Jheald (talk) 19:56, 31 October 2020 (UTC)Query: SELECT DISTINCT
  ?name ?minister ?moves ?seq ?place_name ?from_lat ?from_lon ?lat ?lon

WITH {
  SELECT DISTINCT ?minister ?place ?StartTime ?res_stmt WHERE {
    ?minister wdt:P106 wd:Q1423891 .
    ?minister p:P551 ?res_stmt .
    ?res_stmt ps:P551 ?place .
    ?res_stmt pq:P580 ?StartTime .
      #pq:P582 ?EndTime .
    
  } ORDER BY ?minister ?StartTime
} AS %ministers

WITH {
  SELECT DISTINCT ?minister (COUNT(DISTINCT(?rs1)) AS ?seq) ?place ?StartTime WHERE {
    INCLUDE %ministers .
    {
      SELECT DISTINCT ?minister (?place AS ?pl1) (?StartTime AS ?st1) (?res_stmt AS ?rs1) WHERE {
        INCLUDE %ministers .
      }
    }
    FILTER ((?st1 < ?StartTime) || ((?st1 = ?StartTime) && (STR (?rs1) <= STR(?res_stmt)))) .
  } GROUP BY ?minister ?place ?StartTime ?res_stmt
  ORDER BY ?minister ?seq
} AS %ministers_seq 

WITH {
  SELECT DISTINCT ?minister ?seq (COALESCE(?from1, ?place) AS ?from) ?place ?place_name ?StartTime WHERE {
    INCLUDE %ministers_seq .
    BIND ((?seq) AS ?seq1) .
    OPTIONAL {
      SELECT ?minister (?seq + 1 AS ?seq1) (?place AS ?from1) WHERE {
         INCLUDE %ministers_seq .
      }
    }
    FILTER (bound(?from1)|| bound(?place)) .
    SERVICE wikibase:label {
       bd:serviceParam wikibase:language \"en\".
       ?place rdfs:label ?place_name .
    }
    
  }
} AS %ministers_moves


WITH {
  SELECT ?minister (MAX(?seq) AS ?moves) WHERE {
    INCLUDE %ministers_seq
  } GROUP BY ?minister
} AS %ministers_total

WHERE {  
  INCLUDE %ministers_moves.
  INCLUDE %ministers_total.
  
  ?place p:P625 / psv:P625 / wikibase:geoLatitude ?lat .
  ?place p:P625 / psv:P625 / wikibase:geoLongitude ?lon . 
  ?from  p:P625 ?from_coords_stmt .
         
  ?from_coords_stmt psv:P625 / wikibase:geoLatitude  ?from_lat .
  ?from_coords_stmt  psv:P625 / wikibase:geoLongitude ?from_lon . 
 

  SERVICE wikibase:label {
       bd:serviceParam wikibase:language \"en\".
       ?minister rdfs:label ?name .
  }
} 
ORDER BY DESC(?moves) ?minister ?seq
 Try it! I’m not sure what makes the optimizer choose the wrong order, but disabling it just for the final part of the query seems to help (hint:SubQuery hint:optimizer \"None\".). SELECT DISTINCT
  ?name ?minister ?moves ?seq ?place_name ?from_lat ?from_lon ?lat ?lon

WITH {
  SELECT DISTINCT ?minister ?place ?StartTime ?res_stmt WHERE {
    ?minister wdt:P106 wd:Q1423891 .
    ?minister p:P551 ?res_stmt .
    ?res_stmt ps:P551 ?place .
    ?res_stmt pq:P580 ?StartTime .
      #pq:P582 ?EndTime .
    
  } ORDER BY ?minister ?StartTime
} AS %ministers

WITH {
  SELECT DISTINCT ?minister (COUNT(DISTINCT(?rs1)) AS ?seq) ?place ?StartTime WHERE {
    INCLUDE %ministers .
    {
      SELECT DISTINCT ?minister (?place AS ?pl1) (?StartTime AS ?st1) (?res_stmt AS ?rs1) WHERE {
        INCLUDE %ministers .
      }
    }
    FILTER ((?st1 < ?StartTime) || ((?st1 = ?StartTime) && (STR (?rs1) <= STR(?res_stmt)))) .
  } GROUP BY ?minister ?place ?StartTime ?res_stmt
  ORDER BY ?minister ?seq
} AS %ministers_seq 

WITH {
  SELECT DISTINCT ?minister ?seq (COALESCE(?from1, ?place) AS ?from) ?place ?place_name ?StartTime WHERE {
    INCLUDE %ministers_seq .
    BIND ((?seq) AS ?seq1) .
    OPTIONAL {
      SELECT ?minister (?seq + 1 AS ?seq1) (?place AS ?from1) WHERE {
         INCLUDE %ministers_seq .
      }
    }
    FILTER (bound(?from1)|| bound(?place)) .
    SERVICE wikibase:label {
       bd:serviceParam wikibase:language \"en\".
       ?place rdfs:label ?place_name .
    }
    
  }
} AS %ministers_moves


WITH {
  SELECT ?minister (MAX(?seq) AS ?moves) WHERE {
    INCLUDE %ministers_seq
  } GROUP BY ?minister
} AS %ministers_total

WHERE {  
  INCLUDE %ministers_moves.
  INCLUDE %ministers_total.
  
  hint:SubQuery hint:optimizer \"None\".
  
  ?place p:P625 / psv:P625 / wikibase:geoLatitude ?lat .
  ?place p:P625 / psv:P625 / wikibase:geoLongitude ?lon . 
  ?from  p:P625 ?from_coords_stmt .
         
  ?from_coords_stmt psv:P625 / wikibase:geoLatitude  ?from_lat .
  ?from_coords_stmt psv:P625 / wikibase:geoLongitude ?from_lon . 
 

  SERVICE wikibase:label {
       bd:serviceParam wikibase:language \"en\".
       ?minister rdfs:label ?name .
  }
} 
ORDER BY DESC(?moves) ?minister ?seq
 Try it! --TweetsFactsAndQueries (talk) 20:12, 31 October 2020 (UTC) Thanks, Lucas! Jheald (talk) 14:59, 1 November 2020 (UTC) #TEMPLATE Any idea why https://w.wiki/jff shows the name of the query on the right side, but https://w.wiki/jns doesn't? --- Jura 09:47, 2 November 2020 (UTC) That the second uses a named subquery seems to be the difference. Remove it (without any care & attention to the query) and voila. https://w.wiki/jos --Tagishsimon (talk) 11:12, 2 November 2020 (UTC) Thanks! I also tried a version where one picks the items to compare with based one a values query, but that didn't work out either. Sample: https://w.wiki/jp6 Wikidata:SPARQL_query_service/queries/examples#US_presidents_and_spouses is a working sample. (The only I found) --- Jura 11:28, 2 November 2020 (UTC) Interesting stuff with which I was not familiar. In the working example, I see a variable name switch from ?country to ?id, but applying that to yours didn't fix it. --Tagishsimon (talk) 11:39, 2 November 2020 (UTC) Yes, ?id seems required, fixing that and simplifying it somehow gets it to work: https://w.wiki/jpX . Thanks! --- Jura 11:56, 2 November 2020 (UTC)  #TEMPLATE={\"template\":\"Identifiers present on ?comparewith , but not on the item for Sean Connery\",\"variables\":{\"?comparewith\":{\"query\":\"SELECT DISTINCT ?id WHERE { VALUES ?id { wd:Q81520 wd:Q181917 wd:Q4547 wd:Q134333 wd:Q41233 wd:Q205599 wd:Q37459 wd:Q7374 }  } \" } } }
SELECT
  ?p ?pLabel ?comparewithLabel
  (SAMPLE(?url) AS ?url_comp2) 
WHERE 
{
  BIND(wd:Q39666 as ?comparewith)
  hint:Query hint:optimizer \"None\".
  {  ?comparewith ?wdt ?v.
     ?p wikibase:directClaim ?wdt; wikibase:propertyType wikibase:ExternalId.
     FILTER NOT EXISTS { wd:Q4573 ?wdt [] }
        FILTER NOT EXISTS { ?p wdt:P31 wd:Q66712599 }
        FILTER NOT EXISTS { ?p wdt:P31 wd:Q27525351 }
        FILTER NOT EXISTS { ?p wdt:P31 wd:Q66118402 }   
     OPTIONAL { ?p wdt:P1630 ?f. } BIND(URI(REPLACE(?f, \"\\\\$1\", ?v)) AS ?url)
  } UNION { BIND( wd:Q4573 as ?p) }
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\"}
}
GROUP BY ?p ?pLabel ?comparewithLabel
ORDER BY (?url_comp2)Try it!Somehow this merges: 76 identifiers present on the item for Penelope Cruz, but not on the item for Sean Connery 96 identifiers present on items of other movie stars, but not on the item for Sean Connery Updated it on Wikidata:Status_updates/Next. --- Jura 12:03, 2 November 2020 (UTC) Persons having an ID on Canadian Encyclopedia artikkel-ID May I have a list of persons having an article on norwegian wikipedia (nb), and also having an Canadian Encyclopedia article ID (P5395). Pmt (talk) 10:10, 2 November 2020 (UTC) @Pmt: nb or no? The first finds nothing. The second, implemented below, more successful. Easy to tweak if you need to. SELECT ?item ?itemLabel ?ID ?sitelink ?article 
WHERE 
{
  ?item wdt:P5395 ?ID. 
  ?article schema:about ?item ;
          schema:isPartOf <https://no.wikipedia.org/> ;
          schema:name ?sitelink  .
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],no,en\". }
}
 Try it! --Tagishsimon (talk) 11:05, 2 November 2020 (UTC) There is no nb.wikipedia.org (the subdomain redirects to no.wikipedia.org) which explains why it doesn't give any results. There is a nn.wikipedia.org (Norgewian nynorsk) with results. --Dipsacus fullonum (talk) 11:26, 2 November 2020 (UTC) Member of Organized Crime gangs I'm looking for gangsters sentenced to prison I suppose the data is incomplete but a search does give a few: SELECT ?item ?itemLabel ?penalty ?penaltyLabel
WHERE 
{
  ?item wdt:P31 wd:Q5 . # Human
  ?item wdt:P106 wd:Q46961 . # Gangster
  ?item wdt:P1596 ?penalty . # Penalty
  ?penalty wdt:P279* wd:Q841236 . # Penalty is a subclass of imprisonment
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\" . }
}
 Try it! --Dipsacus fullonum (talk) 20:24, 2 November 2020 (UTC) Query to Obtain City of the Airport [SOLVED] I am interested in learning which airport is located in which city. With a little bit of work I had the code of looking up the airport from its ICAO code working.(https://w.wiki/jxo) However I am having difficulties trying to get the city where the airport is located.located in the administrative territorial entity (P131) looks promising, but a few attempts reveals that it would not only return the city of the airport, but also the province, the state, the municipality, etc. For example, RJAA (Narita International Airport near Tokyo, Japan) has both Narita (the city) and Chiba Perfecture listed there, KUNV (University Park Airport in State College, Pennsylvania, USA) only has Pensylvania listed, and ZSQD (Qingdao Liuting International Airport in Qingdao, Shandong, China) only has Chengyang District (one level lower than city) listed.I came with two solutions but failed to put the codes together.The first solution is to keep using the wdt:P131 and set up a filter to remove anything that is not a city. SELECT ?airport ?airportLabel ?airportIn ?airportInLabel ?airportInType ?airportInTypeLabel WHERE {
  ?airport wdt:P239 \"RJAA\".
  { ?airport wdt:P131 ?airportIn. }
  { ?airportIn wdt:P31 ?airportInType. }
  FILTER(EXISTS { ?airportInType wdt:P279 wd:Q515. })
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }
}
 Try it! It only works with RJAA as it has Narita P31 Q494721 (instance of City of Japan) and Q494721 P279 Q515 (subclass of City). It did not work with ZGGG which has Guangzhou P31 Q515 (instance of City), nor did it work with those airports that only has P131 with districts. Of course I can also manually add those instance of cities into each airport's wikidata entry but that is likely going to take a lot of effort and introduce some redundant info (such as RJAA wdt:P131 Narita wdt:P31 ((city of Japan) AND (city))).The second solution is to take the coordinate of the airport and to do a query to find out which city this coordinate belongs to. I am afraid that it may take way too much resources and I have no idea about how to write a query for such.Please let me know if you have any other thoughts on how I can build a query that takes an ICAO airport code and returns the city the airport is located at.Staph aureus (talk) 17:52, 3 November 2020 (UTC) It really depends what you are looking for. Maybe place served by transport hub (P931) suits you better? If there are multiple values, query the closest or the most populous one. --- Jura 18:18, 3 November 2020 (UTC) Before I may be able to help, I need to know what you mean by \"City of the Airport\". I live in Denmark and none of the Danish airports that I know of are located in a city, but somewhere in the country outside any city. --Dipsacus fullonum (talk) 21:34, 3 November 2020 (UTC) To make things simpler, I am assuming that every airport, as a building, has its address, and every address has a component of \"City\" or its local equivalent. That is what I am looking for. For Kansai International Airport, I am happy to take Izumisano city instead of the nearby Osaka city. For Vancouver International Airport, I am also happy to take Richmond instead of Vancouver. However if this is more difficult than taking the \"largest city nearby\" then I think I can accept either one. --Staph aureus (talk) 23:45, 3 November 2020 (UTC) Actually Jura's idea of using place served by transport hub (P931) is quite brilliant. Could not believe I missed out such a good property when I was staring at those airports. SELECT ?airport ?airportLabel ?airportIn ?airportInLabel WHERE {
  ?airport wdt:P239 \"RJAA\".
  { ?airport wdt:P931 ?airportIn. }
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }
}
 Try it! It works like a charm now. Thanks for your help. --Staph aureus (talk) 00:00, 4 November 2020 (UTC) @Staph aureus: named after (P138) could be another option. I added a quite a few some time ago (adding more precise P131 seemed less interesting to me). If it's a place, it's usually similar to place served by transport hub (P931) or the other place you were looking for. Querying the distance between these finds a few exceptions. --- Jura 07:22, 4 November 2020 (UTC) Is it possible to list people with items created in the last 12 months? #Mujeres mexicanas
SELECT ?item ?name ?image ?gender ?year_of_birth ?country_of_birth
       (GROUP_CONCAT(DISTINCT ?state_or_province_of_birth; separator=\", \") AS ?states_or_provinces_of_birth)
       ?year_of_death ?country_of_death ?occupations
WITH
{
  SELECT ?item ?image ?gender_item ?year_of_birth ?country_of_birth_item
         ?year_of_death ?country_of_death_item
         (GROUP_CONCAT(?occupation; SEPARATOR=\", \") AS ?occupations)
  WHERE
  {
    ?item wdt:P21 wd:Q6581072 .
    ?item wdt:P27 wd:Q96 .
    OPTIONAL {
      ?item wdt:P18 ?image.
    }
    OPTIONAL {
      ?item wdt:P21 ?gender_item.
    }
    ?item wdt:P569 ?date_of_birth.
    BIND (YEAR(?date_of_birth) AS ?year_of_birth)
    FILTER (?year_of_birth >= 1675 && ?year_of_birth < 1995)
    OPTIONAL {
      ?item wdt:P19/wdt:P17 ?country_of_birth_item.
    }
    OPTIONAL {
      ?item wdt:P570 ?date_of_death.
      BIND (YEAR(?date_of_death) AS ?year_of_death)
    }
    OPTIONAL {
      ?item wdt:P20/wdt:P17 ?country_of_death_item.
    }
    OPTIONAL {
      ?item wdt:P106 ?occupation_item.
    }
    SERVICE wikibase:label {
      bd:serviceParam wikibase:language \"es,en\".
      ?occupation_item rdfs:label ?occupation.
    }
  }
  GROUP BY ?item ?image ?gender_item ?year_of_birth ?country_of_birth_item ?year_of_death ?country_of_death_item
} AS %query
WHERE
{
  INCLUDE %query
  OPTIONAL {
    ?state_or_province_of_birth_item wdt:P131 ?country_of_birth_item.
    ?item wdt:P19/wdt:P131* ?state_or_province_of_birth_item.
  }
  SERVICE wikibase:label {
    bd:serviceParam wikibase:language \"es,en\".
    ?item rdfs:label ?name.
    ?gender_item rdfs:label ?gender.
    ?country_of_birth_item rdfs:label ?country_of_birth.
    ?country_of_death_item rdfs:label ?country_of_death.
    ?state_or_province_of_birth_item rdfs:label ?state_or_province_of_birth.
  }
}
GROUP BY ?item ?name ?image ?gender ?year_of_birth ?country_of_birth ?year_of_death ?country_of_death ?occupations
 Try it!Hi, it's been almost 9 months since my last application. And I'd like to add the women's items that have been created since April. This is so I can add them to my personal wikirepository. Is that possible? so that I don't have to go through the 3000+ items from women born in Mexico one by one. Greetings. --Hispano76 (talk) 20:58, 3 November 2020 (UTC)Items used: female (Q6581072)   , Mexico (Q96)   , QID milestone (Q38074555)   Properties used: sex or gender (P21)   , country of citizenship (P27)   , quantity (P1114)   , point in time (P585)   # by Jura1, 2020-11-03
#defaultView:AreaChart
SELECT ?date ?cumulativecount 
{
    hint:Query hint:optimizer \"None\".
    {   SELECT ?milestonep (COUNT(?item) as ?cumulativecount)
        WHERE
        {
          { SELECT ?item {    ?item wdt:P21 wd:Q6581072 . ?item wdt:P27 wd:Q96 . }  LIMIT 190000 }
          BIND( xsd:integer( substr(str(?item), 33)) as ?qid)
          wd:Q38074555 p:P1114 ?milestonep .
          ?milestonep ps:P1114 ?milestone .
          FILTER( ?milestone > ?qid ) 
        }
        GROUP BY ?milestonep
    }          
    ?milestonep pq:P585 ?date
} Try it!The above gives you an idea when they were created. However, it could be that P27=Q96 was added only later.Q88888888 was created at the end of March, so anything more recent would be new since. --- Jura 21:04, 3 November 2020 (UTC) A relative simple approach is find an item created on the limit date. Remove the \"Q\" from the item names and convert the number part to integers. Any items with greater integers than the item from the limit date are created later than that. It is also possible to get the exact creation time for any item with a precision of 1 second by using a MWAPI call but it is limited how many items you can query about in one query without causing timeout. --Dipsacus fullonum (talk) 21:48, 3 November 2020 (UTC) I would agree that the easiest solution here is to use the QID as a proxy for age, with any ID past your cut-off being new. There may be a few weird cases where an item was created before, a duplicate was created after, and the old item was merged into the new one - but this situation is very unusual. Andrew Gray (talk) 22:52, 3 November 2020 (UTC) @Hispano76: So for example if you only want items created later than Q88000000 from 19 Mar 2020 insert this filter in your code: FILTER (xsd:integer(SUBSTR(STR(?item),33)) > 88000000)
 You can adjust the number as you like to get the right cut off date. --Dipsacus fullonum (talk) 07:57, 4 November 2020 (UTC) gsbbox equivalent Hi. Is there any way to get all items with coordinates inside a bound box? Like this API. --ԱշոտՏՆՂ (talk) 06:20, 4 November 2020 (UTC) @ԱշոտՏՆՂ: Yes, see the section mw:Wikidata Query Service/User Manual#Geospatial search in the WDQS user manual. There is also example code there. --Dipsacus fullonum (talk) 07:00, 4 November 2020 (UTC) Ruth (Surname) I am looking for people with the surname Ruth with no article at hewiki. Thanks. YoavR (talk) 16:50, 2 November 2020 (UTC) @YoavR: SELECT ?item ?itemLabel
WHERE 
{
  ?item wdt:P31 wd:Q5 . # Human
  ?item wdt:P734 wd:Q37494439 . # Surname is Ruth
  MINUS
  {
    ?article schema:about ?item .
    ?article schema:isPartOf <https://he.wikipedia.org/> . # No article at hewiki
  }
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en,he\". }
}
 Try it! --Dipsacus fullonum (talk) 20:02, 2 November 2020 (UTC) Thank you very much. YoavR (talk) 20:35, 2 November 2020 (UTC) @YoavR: I'll be adding another 55 names to that report in an hour or so (just waiting for quickstatements to get around to it) based on this query --Tagishsimon (talk) 20:52, 2 November 2020 (UTC) Might as well combine those two for the lols: SELECT DISTINCT ?item ?itemLabel 
WHERE {
  hint:Query hint:optimizer \"None\".
  {  
    SERVICE wikibase:mwapi {
      bd:serviceParam wikibase:api \"Search\";
                      wikibase:endpoint \"www.wikidata.org\";
                      mwapi:srsearch \"Ruth\".
      ?title wikibase:apiOutput mwapi:title.
    }
    BIND(IRI(CONCAT(STR(wd:), ?title)) AS ?item)
    ?item rdfs:label ?itemLabel . filter(lang(?itemLabel)=\"en\")
    FILTER NOT EXISTS { ?item wdt:P734 wd:Q37494439 .}
    FILTER(regex(?itemLabel,\".+Ruth$\"))
  }
  UNION
  {
    ?item wdt:P734 wd:Q37494439 . # Surname is Ruth
  }
  MINUS
  {
    ?article schema:about ?item .
    ?article schema:isPartOf <https://he.wikipedia.org/> . # No article at hewiki
  }
  ?item wdt:P31 wd:Q5
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
}
 Try it! --Tagishsimon (talk) 21:06, 2 November 2020 (UTC) @Tagishsimon: A little tip for another time. You can extract ?item directly from the MWAPI service by using the predicate wikibase:apiOutputItem that automatically converts the title to an IRI for an item. That will make query many times faster. Instead of the normally expensive REGEX function you can also use the simpler FILTER STRENDS(?itemLabel, \"Ruth\") but I doubt it will very noticeable in this case. --Dipsacus fullonum (talk) 06:59, 3 November 2020 (UTC) Isn't regex usually quicker than the less technical functions (strends, strstarts, ..)? --- Jura 07:18, 3 November 2020 (UTC) That depends on how they are implemented. If STRENDS and STRSTARTS for instance just are wrappers for REGEX, you are right. But they will always be faster if you write a specialized optimized implementation for them. --Dipsacus fullonum (talk) 07:40, 3 November 2020 (UTC) Well, at Wikidata Query Service. --- Jura 08:50, 3 November 2020 (UTC) Depending on whether you want to include or exclude Del Ruth (Q93133323) or other surnames, you might want to filter just for FILTER NOT EXISTS { ?item wdt:P734 [] }. --- Jura 07:16, 3 November 2020 (UTC) I fixed a few that used \"Ruth\" instead of \"Del Ruth\" or \"van Ruth\". --- Jura 08:50, 3 November 2020 (UTC) @Tagishsimon: how will you tell from your query which person has surname Ruth and which has given name Ruth? --Infovarius (talk) 20:51, 4 November 2020 (UTC) Modify a query to cast the same globe Hello, I'd like to modify this query so that the given item (Q867556 in this example)'s globe should also be used to filter anything that is in a 10-km radius around the point of Q867556, in the same globe. Thanks! Bouzinac 💬●✒️●💛 08:28, 4 November 2020 (UTC) SELECT ?globe ?place ?placeLabel ?location ?instanceLabel ?dist WHERE {
  wd:Q867556 wdt:P625 ?loc .
  SERVICE wikibase:around {
      ?place wdt:P625 ?location .
      bd:serviceParam wikibase:center ?loc.
      bd:serviceParam wikibase:geoGlobe ?globe . 
      bd:serviceParam wikibase:radius 10 . # in kilometers
  }
 # FILTER ( ?globe = wd:Q2 )
  OPTIONAL { 
    ?place wdt:P31 ?instance .
  }
  SERVICE wikibase:label { bd:serviceParam wikibase:language 'en' }
  BIND(geof:distance(?loc, ?location) AS ?dist) .
} ORDER BY ASC(?dist)
 Try it! – The preceding unsigned comment was added by Bouzinac (talk • contribs). \"geoGlobe\" should be \"globe\", but I'm not sure if that works well with wikibase:radius though. BTW We are trying to improve the situation for non-Earth coordinates currently mixed into P625, see Wikidata:Property_proposal/planetary_coordinates. --- Jura 08:57, 4 November 2020 (UTC) @Bouzinac: The geospatial search gives an error message if the globe parameter isn't a constant. So it will be necessary to first make one query to get the globe, and then make another query with the found globe inserted as a constant. If a bound variable was possible you could use this query: SELECT ?globe ?place
WHERE
{
  wd:Q867556 p:P625 ?locstatement .
  ?locstatement a wikibase:BestRank .
  ?locstatement ps:P625 ?loc .
  ?locstatement psv:P625 / wikibase:geoGlobe ?globe .
  SERVICE wikibase:around {
      ?place wdt:P625 ?location .
      bd:serviceParam wikibase:center ?loc.
      bd:serviceParam wikibase:globe ?globe . 
      bd:serviceParam wikibase:radius 10 . # in kilometers
  }
}
 Try it! But it fails with java.lang.IllegalArgumentException: Non-constant globe value is not supported yet. The word \"yet\" suggests that it will be supported in the future, but you will have to ask development team if there are any plans for that. --Dipsacus fullonum (talk) 14:16, 4 November 2020 (UTC) If if you set the globe to a constant ( wd:Q405 ), radius seems still to assume Q2 .. --- Jura 15:07, 4 November 2020 (UTC) That's not what I'm finding. SELECT ?globe ?place
WHERE
{
  wd:Q867556 p:P625 ?locstatement .
  ?locstatement a wikibase:BestRank .
  ?locstatement ps:P625 ?loc .
  ?locstatement psv:P625 / wikibase:geoGlobe ?globe .
  SERVICE wikibase:around {
      ?place wdt:P625 ?location .
      bd:serviceParam wikibase:center ?loc.
      bd:serviceParam wikibase:globe wd:Q405 . 
      bd:serviceParam wikibase:radius 10 . # in kilometers
  }
}
 Try it! --Tagishsimon (talk) 16:01, 4 November 2020 (UTC) The query has the unit only in a comment. How did you find it? --- Jura 16:12, 4 November 2020 (UTC) I'm not sure what you're asking. I set the globe parameter to a constant and the query searched a radius around a point on the moon, as Df specified it would, above. --Tagishsimon (talk) 16:33, 4 November 2020 (UTC) The question is if it searches 10 km around it or not. --- Jura 16:35, 4 November 2020 (UTC) Here is an expanded version of the query: Items used: Chacornac (Q867556)   , Moon (Q405)   Properties used: coordinate location (P625)   """@en;
  dcterms:isPartOf <https://www.wikidata.org//wiki/Wikidata:Request_a_query/Archive/2020/11>;
  dcterms:license <https://creativecommons.org/licenses/by-sa/4.0/>;
  sh:prefixes _:genid-4e694113159d4e3db4a1a913894a81d81238-wikidata_prefixes;
  schema:target <https://query.wikidata.org/sparql/>;
  sh:select """PREFIX wikibase: <http://wikiba.se/ontology#>
PREFIX wdt: <http://www.wikidata.org/prop/direct/>
PREFIX wd: <http://www.wikidata.org/entity/>
PREFIX bd: <http://www.bigdata.com/rdf#>
SELECT ?loc0 ?loc1 ?place1 ?place1Label ?distWBaround ?distGEOF
WHERE
{
  wd:Q867556 wdt:P625  ?loc0 .
  SERVICE wikibase:around {
      ?place1 wdt:P625 ?loc1 .
      bd:serviceParam wikibase:center ?loc0 .
      bd:serviceParam wikibase:globe wd:Q405 . 
      bd:serviceParam wikibase:radius 200 . # which unit ?
      bd:serviceParam wikibase:distance ?distWBaround . # which unit ?
  }
  BIND(geof:distance(?loc1, ?loc0) as ?distGEOF) # which unit ?
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"[AUTO_LANGUAGE],en\". }
}""" .
